var k=Object.defineProperty;var j=(e,t,n)=>t in e?k(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var c=(e,t,n)=>j(e,typeof t!="symbol"?t+"":t,n);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))r(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&r(o)}).observe(document,{childList:!0,subtree:!0});function n(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(i){if(i.ep)return;i.ep=!0;const s=n(i);fetch(i.href,s)}})();function T(e){return e*Math.PI/180}var S=1e-6,w=typeof Float32Array<"u"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)});function q(){var e=new w(9);return w!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[5]=0,e[6]=0,e[7]=0),e[0]=1,e[4]=1,e[8]=1,e}function A(){var e=new w(16);return w!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function H(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function W(e,t,n){var r=n[0],i=n[1],s=n[2],o,a,h,d,u,l,p,f,g,x,m,y;return t===e?(e[12]=t[0]*r+t[4]*i+t[8]*s+t[12],e[13]=t[1]*r+t[5]*i+t[9]*s+t[13],e[14]=t[2]*r+t[6]*i+t[10]*s+t[14],e[15]=t[3]*r+t[7]*i+t[11]*s+t[15]):(o=t[0],a=t[1],h=t[2],d=t[3],u=t[4],l=t[5],p=t[6],f=t[7],g=t[8],x=t[9],m=t[10],y=t[11],e[0]=o,e[1]=a,e[2]=h,e[3]=d,e[4]=u,e[5]=l,e[6]=p,e[7]=f,e[8]=g,e[9]=x,e[10]=m,e[11]=y,e[12]=o*r+u*i+g*s+t[12],e[13]=a*r+l*i+x*s+t[13],e[14]=h*r+p*i+m*s+t[14],e[15]=d*r+f*i+y*s+t[15]),e}function X(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,e}function K(e,t,n,r,i){var s=1/Math.tan(t/2),o;return e[0]=s/n,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=s,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,i!=null&&i!==1/0?(o=1/(r-i),e[10]=(i+r)*o,e[14]=2*i*r*o):(e[10]=-1,e[14]=-2*r),e}var J=K;function Q(e,t,n,r){var i,s,o,a,h,d,u,l,p,f,g=t[0],x=t[1],m=t[2],y=r[0],D=r[1],z=r[2],I=n[0],Y=n[1],N=n[2];return Math.abs(g-I)<S&&Math.abs(x-Y)<S&&Math.abs(m-N)<S?H(e):(u=g-I,l=x-Y,p=m-N,f=1/Math.hypot(u,l,p),u*=f,l*=f,p*=f,i=D*p-z*l,s=z*u-y*p,o=y*l-D*u,f=Math.hypot(i,s,o),f?(f=1/f,i*=f,s*=f,o*=f):(i=0,s=0,o=0),a=l*o-p*s,h=p*i-u*o,d=u*s-l*i,f=Math.hypot(a,h,d),f?(f=1/f,a*=f,h*=f,d*=f):(a=0,h=0,d=0),e[0]=i,e[1]=a,e[2]=u,e[3]=0,e[4]=s,e[5]=h,e[6]=l,e[7]=0,e[8]=o,e[9]=d,e[10]=p,e[11]=0,e[12]=-(i*g+s*x+o*m),e[13]=-(a*g+h*x+d*m),e[14]=-(u*g+l*x+p*m),e[15]=1,e)}function P(){var e=new w(3);return w!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function Z(e){var t=new w(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function tt(e){var t=e[0],n=e[1],r=e[2];return Math.hypot(t,n,r)}function _(e,t,n){var r=new w(3);return r[0]=e,r[1]=t,r[2]=n,r}function et(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function C(e,t,n,r){return e[0]=t,e[1]=n,e[2]=r,e}function $(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],e}function R(e,t){var n=t[0],r=t[1],i=t[2],s=n*n+r*r+i*i;return s>0&&(s=1/Math.sqrt(s)),e[0]=t[0]*s,e[1]=t[1]*s,e[2]=t[2]*s,e}function rt(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function B(e,t,n){var r=t[0],i=t[1],s=t[2],o=n[0],a=n[1],h=n[2];return e[0]=i*h-s*a,e[1]=s*o-r*h,e[2]=r*a-i*o,e}function U(e,t,n){var r=n[0],i=n[1],s=n[2],o=n[3],a=t[0],h=t[1],d=t[2],u=i*d-s*h,l=s*a-r*d,p=r*h-i*a,f=i*p-s*l,g=s*u-r*p,x=r*l-i*u,m=o*2;return u*=m,l*=m,p*=m,f*=2,g*=2,x*=2,e[0]=a+u+f,e[1]=h+l+g,e[2]=d+p+x,e}var nt=tt;(function(){var e=P();return function(t,n,r,i,s,o){var a,h;for(n||(n=3),r||(r=0),i?h=Math.min(i*n+r,t.length):h=t.length,a=r;a<h;a+=n)e[0]=t[a],e[1]=t[a+1],e[2]=t[a+2],s(e,e,o),t[a]=e[0],t[a+1]=e[1],t[a+2]=e[2];return t}})();function it(){var e=new w(4);return w!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}function st(e,t){var n=t[0],r=t[1],i=t[2],s=t[3],o=n*n+r*r+i*i+s*s;return o>0&&(o=1/Math.sqrt(o)),e[0]=n*o,e[1]=r*o,e[2]=i*o,e[3]=s*o,e}(function(){var e=it();return function(t,n,r,i,s,o){var a,h;for(n||(n=4),r||(r=0),i?h=Math.min(i*n+r,t.length):h=t.length,a=r;a<h;a+=n)e[0]=t[a],e[1]=t[a+1],e[2]=t[a+2],e[3]=t[a+3],s(e,e,o),t[a]=e[0],t[a+1]=e[1],t[a+2]=e[2],t[a+3]=e[3];return t}})();function F(){var e=new w(4);return w!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}function ot(e,t,n){n=n*.5;var r=Math.sin(n);return e[0]=r*t[0],e[1]=r*t[1],e[2]=r*t[2],e[3]=Math.cos(n),e}function L(e,t,n,r){var i=t[0],s=t[1],o=t[2],a=t[3],h=n[0],d=n[1],u=n[2],l=n[3],p,f,g,x,m;return f=i*h+s*d+o*u+a*l,f<0&&(f=-f,h=-h,d=-d,u=-u,l=-l),1-f>S?(p=Math.acos(f),g=Math.sin(p),x=Math.sin((1-r)*p)/g,m=Math.sin(r*p)/g):(x=1-r,m=r),e[0]=x*i+m*h,e[1]=x*s+m*d,e[2]=x*o+m*u,e[3]=x*a+m*l,e}function at(e,t){var n=t[0]+t[4]+t[8],r;if(n>0)r=Math.sqrt(n+1),e[3]=.5*r,r=.5/r,e[0]=(t[5]-t[7])*r,e[1]=(t[6]-t[2])*r,e[2]=(t[1]-t[3])*r;else{var i=0;t[4]>t[0]&&(i=1),t[8]>t[i*3+i]&&(i=2);var s=(i+1)%3,o=(i+2)%3;r=Math.sqrt(t[i*3+i]-t[s*3+s]-t[o*3+o]+1),e[i]=.5*r,r=.5/r,e[3]=(t[s*3+o]-t[o*3+s])*r,e[s]=(t[s*3+i]+t[i*3+s])*r,e[o]=(t[o*3+i]+t[i*3+o])*r}return e}function ct(e,t,n,r){var i=.5*Math.PI/180;t*=i,n*=i,r*=i;var s=Math.sin(t),o=Math.cos(t),a=Math.sin(n),h=Math.cos(n),d=Math.sin(r),u=Math.cos(r);return e[0]=s*h*u-o*a*d,e[1]=o*a*u+s*h*d,e[2]=o*h*d-s*a*u,e[3]=o*h*u+s*a*d,e}var V=st;(function(){var e=P(),t=_(1,0,0),n=_(0,1,0);return function(r,i,s){var o=rt(i,s);return o<-.999999?(B(e,t,i),nt(e)<1e-6&&B(e,n,i),R(e,e),ot(r,e,Math.PI),r):o>.999999?(r[0]=0,r[1]=0,r[2]=0,r[3]=1,r):(B(e,i,s),r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=1+o,V(r,r))}})();(function(){var e=F(),t=F();return function(n,r,i,s,o,a){return L(e,r,o,a),L(t,i,s,a),L(n,e,t,2*a*(1-a)),n}})();(function(){var e=q();return function(t,n,r,i){return e[0]=r[0],e[3]=r[1],e[6]=r[2],e[1]=i[0],e[4]=i[1],e[7]=i[2],e[2]=-n[0],e[5]=-n[1],e[8]=-n[2],V(t,at(t,e))}})();class ht{constructor(t){c(this,"config");c(this,"_projectionMatrix");c(this,"_viewMatrix");c(this,"position");c(this,"rotation");c(this,"up");c(this,"forward");c(this,"right");this.config=t,this._projectionMatrix=A(),this._viewMatrix=A(),this.position=_(0,0,5),this.rotation=F(),this.up=_(0,1,0),this.forward=_(0,0,-1),this.right=_(1,0,0),this.updateProjectionMatrix(),this.updateViewMatrix()}updateProjectionMatrix(){const t=this.config.size.width/this.config.size.height;J(this._projectionMatrix,this.config.fov,t,.1,1e3)}updateViewMatrix(){const t=P();$(t,this.position,this.forward),Q(this._viewMatrix,this.position,t,this.up)}setPosition(t){et(this.position,t),this.updateViewMatrix()}getPosition(){return Z(this.position)}setRotation(t){const n=T(t[0]),r=T(t[1]),i=T(t[2]);ct(this.rotation,n,r,i),C(this.forward,0,0,-1),U(this.forward,this.forward,this.rotation),R(this.forward,this.forward),C(this.right,1,0,0),U(this.right,this.right,this.rotation),R(this.right,this.right),C(this.up,0,1,0),U(this.up,this.up,this.rotation),R(this.up,this.up),this.updateViewMatrix()}translate(t){$(this.position,this.position,t),this.updateViewMatrix()}get projectionMatrix(){return this._projectionMatrix}get viewMatrix(){return this._viewMatrix}}const v=class v{constructor(t,n,r){c(this,"gl");c(this,"program");this.gl=t,this.program=this.createProgram(n,r)}createShader(t,n){const r=this.gl.createShader(t);if(!r)throw new Error("Shader creation failed");if(this.gl.shaderSource(r,n),this.gl.compileShader(r),!this.gl.getShaderParameter(r,this.gl.COMPILE_STATUS)){const s=this.gl.getShaderInfoLog(r);throw this.gl.deleteShader(r),new Error(`Shader compilation failed: ${s}`)}return r}createProgram(t,n){const r=this.createShader(this.gl.VERTEX_SHADER,t),i=this.createShader(this.gl.FRAGMENT_SHADER,n),s=this.gl.createProgram();if(!s)throw new Error("Program creation failed");if(this.gl.attachShader(s,r),this.gl.attachShader(s,i),this.gl.linkProgram(s),!this.gl.getProgramParameter(s,this.gl.LINK_STATUS)){const a=this.gl.getProgramInfoLog(s);throw new Error(`Program linking failed: ${a}`)}return s}use(){this.gl.useProgram(this.program)}setMatrix(t,n,r){this.gl.uniformMatrix4fv(this.getUniformLocation(v.VOCABULARY.uniform.projectionMatrix),!1,t),this.gl.uniformMatrix4fv(this.getUniformLocation(v.VOCABULARY.uniform.viewMatrix),!1,n),this.gl.uniformMatrix4fv(this.getUniformLocation(v.VOCABULARY.uniform.modelMatrix),!1,r)}setTexture(t){this.gl.uniform1i(this.getUniformLocation(v.VOCABULARY.uniform.useTexture),1),this.gl.uniform4f(this.getUniformLocation(v.VOCABULARY.uniform.color),1,1,1,1),this.gl.bindTexture(this.gl.TEXTURE_2D,t.getTexture())}setColor(t){this.gl.uniform1i(this.getUniformLocation(v.VOCABULARY.uniform.useTexture),0),this.gl.uniform4f(this.getUniformLocation(v.VOCABULARY.uniform.color),t[0],t[1],t[2],t[3])}getAttribLocation(t){const n=this.gl.getAttribLocation(this.program,t);if(n===-1)throw new Error(`Attribute ${t} not found`);return n}getUniformLocation(t){return this.gl.getUniformLocation(this.program,t)}};c(v,"VOCABULARY",{attribute:{position:"a_position",texture:"a_texCoord"},uniform:{projectionMatrix:"u_projectionMatrix",viewMatrix:"u_viewMatrix",modelMatrix:"u_modelMatrix",color:"u_color",texture:"u_texture",useTexture:"u_useTexture"}});let E=v;const ft=`#version 300 es
precision mediump float;

// Vertex attributes
in vec4 a_position;
in vec2 a_texCoord;

// Matrices
uniform mat4 u_projectionMatrix;
uniform mat4 u_viewMatrix;
uniform mat4 u_modelMatrix;

out vec2 v_texCoord;

void main() {
  gl_Position = u_projectionMatrix * u_viewMatrix * u_modelMatrix * a_position;
  v_texCoord = a_texCoord;
}`,dt=`#version 300 es
precision mediump float;

uniform vec4 u_color;
uniform bool u_useTexture;
uniform sampler2D u_texture;

in vec2 v_texCoord;

out vec4 outColor;

void main() {
    if (u_useTexture) {
      outColor = texture(u_texture, v_texCoord) * u_color;
    }
    else {
      outColor = u_color;
    }
}`;function ut(e){const t=new E(e,ft,dt);if(!t)throw new Error("Shader creation failed");return t}class lt{constructor(t){c(this,"canvas");c(this,"gl");c(this,"state");c(this,"shader",new Map);c(this,"renderList",new Map);c(this,"camera");if(this.state=this.getDefaultState(),this.updateState("starting","Triton is starting..."),this.canvas=t.canvas||document.createElement("canvas"),t.size?(this.canvas.width=t.size.width,this.canvas.height=t.size.height):(this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,window.onresize=()=>this.handleResize()),document.body.contains(this.canvas)||document.body.appendChild(this.canvas),this.gl=this.canvas.getContext("webgl2"),!this.gl)throw this.updateState("error","WebGL2 not supported"),new Error("WebGL2 not supported");this.glConfig(),this.camera=new ht({fov:45,size:{width:this.canvas.width,height:this.canvas.height}}),this.updateState("running","Triton started successfully")}get State(){return this.state}get Canvas(){return this.canvas}getDefaultState(){return{state:"idle",log:[]}}updateState(t,n){this.state.state=t,this.state.log.push(n)}handleResize(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT)}glConfig(){this.gl.clearColor(0,0,0,1),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthFunc(this.gl.LEQUAL),this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.compileShaders()}compileShaders(){this.shader.set("unlit",ut(this.gl))}addSprite(t,n){this.renderList.has(t)&&console.warn(`Sprite with name ${t} already exists. Overwriting.`),this.renderList.set(t,n),n.init(this.gl,this.shader.get("unlit"))}removeSprite(t){var n;this.renderList.has(t)?((n=this.renderList.get(t))==null||n.destroy(this.gl),this.renderList.delete(t)):console.warn(`Sprite with name ${t} does not exist.`)}getSprite(t){return this.renderList.get(t)}clearRenderList(){this.renderList.forEach(t=>{t.destroy(this.gl)}),this.renderList.clear()}renderFrame(){this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),this.renderList.forEach(t=>{t.render(this.camera.projectionMatrix,this.camera.viewMatrix,this.gl)})}clear(){this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT)}}let pt=0;const b=new Map;class mt{constructor(t){c(this,"imagePath");c(this,"texture",null);c(this,"textureUnit",pt);this.imagePath=t}init(t){if(b.has(this.imagePath)){this.texture=b.get(this.imagePath);return}if(this.texture=t.createTexture(),!this.texture)throw new Error("[ X ] Texture creation failed");t.bindTexture(t.TEXTURE_2D,this.texture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,new Uint8Array([255,0,255,255]));const n=new Image;n.src=this.imagePath,n.onload=()=>{t.bindTexture(t.TEXTURE_2D,this.texture),t.activeTexture(this.textureUnit),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,n),t.generateMipmap(t.TEXTURE_2D),b.set(this.imagePath,this.texture)}}getTexture(){return this.texture}destroy(t){this.texture&&(t.deleteTexture(this.texture),this.texture=null)}}const M={shapes:{Square:{vertices:[-.5,-.5,0,1,.5,-.5,0,1,.5,.5,0,1,-.5,.5,0,1],indices:[0,1,2,2,3,0],texCords:[0,1,1,1,1,0,0,0]}}};class xt{constructor(t){c(this,"vertexBuffer",null);c(this,"indexBuffer",null);c(this,"textureCoordBuffer",null);c(this,"modelMatrix",null);c(this,"shader",null);c(this,"texture",null);c(this,"position",[0,0]);this.texture=new mt(t)}move(t,n){this.modelMatrix&&(this.modelMatrix=W(this.modelMatrix,A(),[t,n,0]))}init(t,n){if(this.vertexBuffer=t.createBuffer(),!this.vertexBuffer)throw new Error("Vertex buffer creation failed");if(t.bindBuffer(t.ARRAY_BUFFER,this.vertexBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(M.shapes.Square.vertices),t.STATIC_DRAW),this.indexBuffer=t.createBuffer(),!this.indexBuffer)throw new Error("Index buffer creation failed");if(t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.indexBuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array(M.shapes.Square.indices),t.STATIC_DRAW),this.textureCoordBuffer=t.createBuffer(),!this.textureCoordBuffer)throw new Error("Texture coordinate buffer creation failed");if(t.bindBuffer(t.ARRAY_BUFFER,this.textureCoordBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(M.shapes.Square.texCords),t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null),this.shader=n,!this.shader)throw new Error("Shader creation failed");if(!this.texture)throw new Error("Texture creation failed");this.texture.init(t),this.modelMatrix=X(A(),_(this.position[0],this.position[1],0))}destroy(t){t.deleteBuffer(this.vertexBuffer),t.deleteBuffer(this.indexBuffer),this.vertexBuffer=null,this.indexBuffer=null,this.modelMatrix=null,this.shader=null}setPosition(t,n){this.position=[t,n]}render(t,n,r){if(!this.vertexBuffer||!this.indexBuffer||!this.modelMatrix||!this.texture||!this.shader)return;this.shader.use(),r.bindBuffer(r.ARRAY_BUFFER,this.vertexBuffer);const i=this.shader.getAttribLocation(E.VOCABULARY.attribute.position);r.enableVertexAttribArray(i),r.vertexAttribPointer(i,4,r.FLOAT,!1,0,0),r.bindBuffer(r.ARRAY_BUFFER,this.textureCoordBuffer);const s=this.shader.getAttribLocation(E.VOCABULARY.attribute.texture);r.enableVertexAttribArray(s),r.vertexAttribPointer(s,2,r.FLOAT,!1,0,0),this.shader.setMatrix(t,n,this.modelMatrix),this.shader.setTexture(this.texture),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,this.indexBuffer),r.drawElements(r.TRIANGLES,M.shapes.Square.indices.length,r.UNSIGNED_SHORT,0),r.bindBuffer(r.ARRAY_BUFFER,null),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null)}}function gt(e,t){return t instanceof Map?{dataType:"Map",value:Array.from(t.entries())}:t}function wt(e,t){return typeof t=="object"&&t!==null&&t.dataType==="Map"?new Map(t.value):t}function vt(e,t=0){return JSON.stringify(e,gt,t)}function _t(e){return JSON.parse(e,wt)}function yt(e){const t=_t(e);if(!t)throw new Error("Failed to load game data");if(!t.metadata)throw new Error("Game data does not contain metadata");return t}class Et{constructor(t=[]){c(this,"_components",[]);this._components=t}getComponent(t){const n=this._components.find(r=>r.type===t);return n?n.data:null}contains(t){return this._components.some(n=>n.type===t)}getComponents(t){return this._components.filter(n=>n.type===t)}addComponent(t){if(this._components.find(n=>n.type===t.type))throw new Error(`Component of type ${t.type} already exists`);this._components.push(t)}removeComponent(t){const n=this._components.findIndex(r=>r.type===t);if(n===-1)throw new Error(`Component of type ${t} does not exist`);this._components.splice(n,1)}}class Mt{constructor(t){c(this,"_scripts",new Map);t.forEach(n=>{this._scripts.set(n.name,n)})}attachScript(t){if(this._scripts.has(t.name))throw new Error(`Script with ID ${t.name} is already attached`);this._scripts.set(t.name,t)}detachScript(t){if(!this._scripts.has(t))throw new Error(`Script with ID ${t} is not attached`);this._scripts.delete(t)}getScripts(){return Array.from(this._scripts.values())}get scripts(){return this._scripts}}class G{constructor(){c(this,"keys",new Map);c(this,"keyDown",new Map);c(this,"keyUp",new Map);window.addEventListener("keydown",t=>{this.keys.set(t.code,!0),this.keyDown.set(t.code,!0)}),window.addEventListener("keyup",t=>{this.keys.set(t.code,!1),this.keyUp.set(t.code,!0)})}isKeyDown(t){return this.keys.get(t)||!1}isKeyUp(t){return this.keyUp.get(t)||!1}isKeyPressed(t){const n=this.keyDown.get(t)||!1;return n&&this.keyDown.set(t,!1),n}}class St{constructor(t){c(this,"_id");c(this,"_name");c(this,"_components");c(this,"_attachedScripts");c(this,"_localScriptContext",{});c(this,"flags",new Map);this._id=t.id,this._name=t.name,this._components=new Et(t.components),this._attachedScripts=new Mt([]),this.flags.set("hasSprite",this._components.contains("sprite")),this.flags.set("hasTransform",this._components.contains("transform"))}Start(t){let n=t;return this._attachedScripts.scripts.forEach(r=>{const i=r.Start({gameObject:this,components:this._components,script:this._localScriptContext,global:n,input:{keyboard:new G}});i&&(this._components=i.components,this._localScriptContext=i.script,n=i.global)}),{scriptContext:n}}Update(t,n){let r=n;return this._attachedScripts.scripts.forEach(i=>{var o,a,h,d;const s=i.Update({gameObject:this,components:this._components,script:this._localScriptContext,global:r,input:{keyboard:t.keyboard}});s&&(this._components=s.components,this._localScriptContext=s.script,r=s.global),this.flags.get("hasSprite")&&((d=(o=this._components.getComponent("sprite"))==null?void 0:o.sprite)==null||d.move(((a=this._components.getComponent("transform"))==null?void 0:a.position[0])??0,((h=this._components.getComponent("transform"))==null?void 0:h.position[1])??0))}),{scriptContext:r}}getComponent(t){const n=this._components.getComponent(t);return n||(console.warn(`Component of type ${t} not found`),null)}updateComponent(t,n){if(!this._components.getComponent(t)){console.warn(`Component of type ${t} not found`);return}this._components.removeComponent(t),this._components.addComponent({type:t,data:n})}get scripts(){return this._attachedScripts}get id(){return this._id}get name(){return this._name}}class Rt{constructor(t,n){c(this,"_name");c(this,"_scriptFunctions",new Map);c(this,"_scriptContext",null);c(this,"_flags",new Map);if(this._name=t,n.scriptURL)throw new Error("Script URL is not supported yet.");if(n.scriptData){const r=this.loadScriptFunctions(n.scriptData);if(!r)throw new Error("Failed to load script functions.");this._scriptFunctions=r}else throw new Error("No script data provided.")}loadScriptFunctions(t){try{const n=`
        with(this) {
          ${t}
          return exports;  
        }
      `,i=new Function(n)(),s=new Map;for(const o in i)typeof i[o]=="function"?(s.has(o)&&console.warn(`Function ${o} is already defined. Overwriting.`),s.set(o,i[o])):console.warn(`Exported value ${o} is not a function.`);return s}catch(n){console.error("Error loading script functions:",n)}}updateGameContext(t){this._scriptContext=t,console.log("Script context updated:",this._scriptContext)}Start(t){var r;const n=(r=this._scriptFunctions.get("Start"))==null?void 0:r.call({...t});if(n)return n;console.warn("Start function not found or did not return a context.")}Update(t){var r;const n=(r=this._scriptFunctions.get("Update"))==null?void 0:r.call({...t});if(n)return n;if(this._flags.get("UpdateWarn"))return;console.warn("Update function not found or did not return a context."),this._flags.set("UpdateWarn",!0)}get name(){return this._name}}class At{constructor(t){c(this,"triton");c(this,"running",!1);c(this,"game",null);c(this,"scene",null);c(this,"objects",new Map);c(this,"keyboard");c(this,"scriptContext",null);t.render.render?this.triton=t.render.render:this.triton=new lt({canvas:t.render.canvas}),this.keyboard=new G}update(){if(!this.running){this.triton.clear();return}if(!this.scene){console.warn("No scene loaded. Cannot update.");return}this.objects.forEach(t=>{this.scriptContext=t.Update({keyboard:this.keyboard},{})}),this.triton.renderFrame(),requestAnimationFrame(this.update.bind(this))}start(){this.running=!0,this.update()}stop(){this.running=!1}loadScene(){if(!this.scene)throw new Error("No scene loaded");this.triton.clearRenderList(),this.objects=new Map,this.scene.objects.forEach(t=>{const n=new St(t);if(this.objects.set(t.name,n),!t.components){console.warn(`Object ${t.name} has no components`);return}t.components.forEach(r=>{switch(r.type){case"sprite":const i=r.data;if(!i.textureLocation){console.warn(`Sprite component for object ${t.name} has no path. Also object data might be missing or wrong.`);return}const s=new xt(i.textureLocation),o=n.getComponent("transform");if(!o){console.error(`Transform component for object ${t.name} is missing or wrong.`);return}const a=n.getComponent("sprite");if(!a)return console.error(`Sprite component for object ${t.name} is missing or wrong.`);a.sprite=s,s.setPosition(o.position[0],o.position[1]),this.triton.addSprite(t.name,s);break;case"script":const h=n.getComponent("script");if(!h){console.error(`Script component for object ${t.name} is missing or wrong.`);return}const d=new Rt(t.name,h);n.scripts.attachScript(d);break}this.scriptContext=n.Start({})})})}saveGame(){if(!this.game)throw new Error("No game loaded");const t=this.game,n=vt(t,2),r=new Blob([n],{type:"application/json"}),i=URL.createObjectURL(r),s=document.createElement("a");s.href=i,s.download="game.json",s.click(),URL.revokeObjectURL(i),console.log("Game saved to game.json")}async loadGame(t){const r=await(await fetch(t)).text(),i=yt(r);if(this.triton.clearRenderList(),i.currentScene||(console.warn("No current scene set in game data. Defaulting to first scene."),i.currentScene=Array.from(i.scenes.keys())[0]),this.scene=i.scenes.get(i.currentScene),!this.scene)throw new Error(`Scene ${i.currentScene} not found`);this.loadScene(),this.game=i}}const O=new At({render:{}});O.loadGame("games/keyboardTest.json").then(()=>{O.start()});window.Hydra=O;
